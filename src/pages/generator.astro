---
import Layout from "../layouts/Layout.astro";
import { ui } from "../i18n/ui.js";

const locale = (Astro.locals.lang as "en" | "fr") ?? "fr";
---

<Layout>
    <div class="flex h-screen bg-gray-100">
        <div class="w-1/2 bg-white flex flex-col border-r border-gray-300">
            <div class="flex justify-end p-4">
                <a href="/galerie" class="btn btn-secondary"
                    >{ui[locale].generator.goToGalerie}</a
                >
            </div>
            <div
                id="svg-container"
                class="flex-1 flex items-center justify-center p-8"
            >
                <div class="text-gray-400 text-center">
                    <svg
                        width="64"
                        height="64"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                        class="mx-auto mb-4"
                    >
                        <path
                            d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
                        ></path>
                    </svg>
                    <p>{ui[locale].generator.yourSvgHere}</p>
                </div>
            </div>
        </div>

        <div class="w-1/2 bg-cyan-400 flex flex-col">
            <div class="bg-cyan-500 text-white text-center py-3 font-semibold">
                {ui[locale].generator.conversation}
            </div>

            <div
                id="chat-container"
                class="flex-1 overflow-y-auto p-4 space-y-4"
            >
                <div class="text-center text-cyan-700 text-sm mb-4">
                    {ui[locale].generator.describe}
                </div>
            </div>

            <div class="p-4 bg-cyan-400 border-t border-cyan-500">
                <div class="flex gap-2">
                    <input
                        type="text"
                        id="user-prompt"
                        placeholder={ui[locale].generator.promptPlaceholder}
                        class="flex-1 px-4 py-3 rounded-lg border-none outline-none text-gray-800"
                    />
                    <button
                        id="generate-button"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium"
                    >
                        {ui[locale].generator.send}
                    </button>
                </div>
                <div class="flex gap-2 mt-3">
                    <button class="btn btn-secondary hidden" id="edit-button">
                        {ui[locale].generator.edit}
                    </button>
                    <button
                        id="save-button"
                        class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium hidden"
                    >
                        {ui[locale].generator.save}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <dialog id="saveModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">
                {ui[locale].generator.saveModalTitle}
            </h3>
            <p class="py-4">
                {ui[locale].generator.saveModalText}
            </p>

            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                <div
                    id="modalSvgPreview"
                    class="flex items-center justify-center h-32"
                >
                </div>
            </div>

            <div class="modal-action">
                <button id="confirmSave" class="btn btn-success">
                    {ui[locale].generator.yesSave}
                </button>
                <button id="cancelSave" class="btn btn-outline">
                    {ui[locale].generator.noCancel}
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <div id="toast" class="toast toast-end hidden">
        <div class="alert alert-success">
            <span>{ui[locale].generator.svgSavedSuccess}</span>
        </div>
    </div>
</Layout>

<script define:vars={{ locale, ui }}>
    //@ts-nocheck

    let promptList = [];
    let currentPrompt = "";
    let currentSvgCode = "";
    let isEditMode = false;
    
    //const user = JSON.parse(localStorage.getItem("user"));
    //console.log("l'utilisateur est : ",user);

    async function saveToPocketBase(prompt, svgCode, chatHistory) {
        try {
            const response = await fetch("/api/saveSVG", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    prompt: prompt,
                    code: svgCode,
                    chat_history: chatHistory,
                   // user: user?.id,
                }),
            });

            if (response.ok) {
                showToast(ui[locale].generator.svgSavedSuccess);
                return true;
            } else {
                console.error(
                    "Erreur lors de la sauvegarde:",
                    await response.text(),
                );
                return false;
            }
        } catch (error) {
            console.error("Erreur lors de la sauvegarde:", error);
            return false;
        }
    }

    function showToast(message) {
        const toast = document.getElementById("toast");
        const alertDiv = toast.querySelector(".alert");
        alertDiv.querySelector("span").textContent = message;
        toast.classList.remove("hidden");

        setTimeout(() => {
            toast.classList.add("hidden");
        }, 3000);
    }

    function addMessageToChat(content, isUser = true) {
        const chatContainer = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");

        if (isUser) {
            messageDiv.className =
                "bg-pink-500 text-white p-3 rounded-lg max-w-xs ml-auto";
            messageDiv.textContent = content;
        } else {
            messageDiv.className =
                "bg-pink-500 text-white p-3 rounded-lg max-w-md";
            messageDiv.innerHTML = `<pre class="whitespace-pre-wrap text-sm font-mono">${content}</pre>`;
        }

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function generateSVG(messages) {
        const res = await fetch("/api/generateSVG", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages }),
        });
        const data = await res.json();
        return data.svg;
    }

    async function handleSubmit() {
        const promptElement = document.getElementById("user-prompt");
        const prompt = promptElement.value.trim();

        if (!prompt) return;

        addMessageToChat(prompt, true);
        promptElement.value = "";

        if (!isEditMode) {
            promptList.length = 0;
            promptList.push({ role: "user", content: prompt });
            currentPrompt = prompt;
            isEditMode = true;
        } else {
            promptList.push({ role: "user", content: prompt });
        }

        const chatContainer = document.getElementById("chat-container");
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "bg-pink-500 text-white p-3 rounded-lg max-w-md";
        loadingDiv.innerHTML = `<span class="loading loading-dots loading-sm"></span> ${ui[locale].generator.generationInProgress}`;
        loadingDiv.id = "loading-message";
        chatContainer.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        const generateButton = document.getElementById("generate-button");
        generateButton.disabled = true;
        generateButton.textContent = ui[locale].generator.generating;

        try {
            const aiResponse = await generateSVG(promptList);

            const loadingMessage = document.getElementById("loading-message");
            if (loadingMessage) {
                loadingMessage.remove();
            }

            console.log("Réponse IA:", aiResponse);

            const svgMatch = aiResponse.content.match(/<svg[\s\S]*?<\/svg>/i);
            const finalSvgCode = svgMatch ? svgMatch[0] : aiResponse.content;

            console.log("SVG final:", finalSvgCode);

            if (finalSvgCode && finalSvgCode.trim() !== "") {
                addMessageToChat(finalSvgCode, false);

                const svgContainer = document.getElementById("svg-container");
                svgContainer.innerHTML = finalSvgCode;

                currentSvgCode = finalSvgCode;
                promptList.push({ role: "assistant", content: finalSvgCode });

                const saveButton = document.getElementById("save-button");
                const editButton = document.getElementById("edit-button");
                saveButton.classList.remove("hidden");
                editButton.classList.remove("hidden");

                const promptInput = document.getElementById("user-prompt");
                promptInput.placeholder = ui[locale].generator.modifyPrompt;
            } else {
                addMessageToChat(ui[locale].generator.noSvgGenerated, false);
            }
        } catch (error) {
            console.error("Erreur lors de la génération:", error);

            const loadingMessage = document.getElementById("loading-message");
            if (loadingMessage) {
                loadingMessage.remove();
            }

            addMessageToChat(ui[locale].generator.generationError, false);
        }

        generateButton.disabled = false;
        generateButton.textContent = ui[locale].generator.send;
    }

    function showSaveModal() {
        const modal = document.getElementById("saveModal");
        const preview = document.getElementById("modalSvgPreview");
        preview.innerHTML = currentSvgCode;
        modal.showModal();
    }

    async function confirmSave() {
        const modal = document.getElementById("saveModal");
        const success = await saveToPocketBase(
            currentPrompt,
            currentSvgCode,
            promptList,
        );

        if (success) {
            const saveButton = document.getElementById("save-button");
            const editButton = document.getElementById("edit-button");
            saveButton.classList.add("hidden");
            editButton.classList.add("hidden");

            promptList = [];
            currentPrompt = "";
            currentSvgCode = "";
            isEditMode = false;

            const promptInput = document.getElementById("user-prompt");
            promptInput.placeholder = ui[locale].generator.promptPlaceholder;

            const chatContainer = document.getElementById("chat-container");
            chatContainer.innerHTML = `
                <div class="text-center text-cyan-700 text-sm mb-4">
                    ${ui[locale].generator.describe}
                </div>
            `;

            const svgContainer = document.getElementById("svg-container");
            svgContainer.innerHTML = `
                <div class="text-gray-400 text-center">
                    <svg
                        width="64"
                        height="64"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                        class="mx-auto mb-4"
                    >
                        <path
                            d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
                        ></path>
                    </svg>
                    <p>${ui[locale].generator.yourSvgHere}</p>
                </div>
            `;
        }

        modal.close();
    }

    function cancelSave() {
        const modal = document.getElementById("saveModal");
        modal.close();
    }

    async function handleEdit() {
        const promptElement = document.getElementById("user-prompt");
        const prompt = promptElement.value.trim();

        if (!prompt) return;

        console.log("Prompt de modification : ", prompt);

        addMessageToChat(prompt, true);
        promptElement.value = "";

        promptList.push({ role: "user", content: prompt });

        const svgContainer = document.getElementById("svg-container");
        const generateButton = document.getElementById("generate-button");
        const editButton = document.getElementById("edit-button");

        const chatContainer = document.getElementById("chat-container");
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "bg-pink-500 text-white p-3 rounded-lg max-w-md";
        loadingDiv.innerHTML = `<span class="loading loading-dots loading-sm"></span> ${ui[locale].generator.modificationInProgress}`;
        loadingDiv.id = "loading-message";
        chatContainer.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        generateButton.disabled = true;
        editButton.disabled = true;

        try {
            const aiResponse = await generateSVG(promptList);

            const loadingMessage = document.getElementById("loading-message");
            if (loadingMessage) {
                loadingMessage.remove();
            }

            const svgMatch = aiResponse.content.match(/<svg[\s\S]*?<\/svg>/i);
            const finalSvgCode = svgMatch ? svgMatch[0] : aiResponse.content;

            console.log("Code SVG modifié : ", finalSvgCode);

            if (finalSvgCode && finalSvgCode.trim() !== "") {
                addMessageToChat(finalSvgCode, false);
                svgContainer.innerHTML = finalSvgCode;
                currentSvgCode = finalSvgCode;
                promptList.push({ role: "assistant", content: finalSvgCode });
            } else {
                addMessageToChat(ui[locale].generator.modificationError, false);
            }
        } catch (error) {
            console.error("Erreur lors de la modification:", error);

            const loadingMessage = document.getElementById("loading-message");
            if (loadingMessage) {
                loadingMessage.remove();
            }

            addMessageToChat(ui[locale].generator.generationError, false);
        }

        generateButton.disabled = false;
        editButton.disabled = false;

        console.log("Historique des prompts : ", promptList);
    }

    const generateButton = document.getElementById("generate-button");
    if (generateButton) {
        generateButton.addEventListener("click", handleSubmit);
    }

    const promptInput = document.getElementById("user-prompt");
    if (promptInput) {
        promptInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                if (isEditMode) {
                    handleEdit();
                } else {
                    handleSubmit();
                }
            }
        });
    }

    const saveButton = document.getElementById("save-button");
    if (saveButton) {
        saveButton.addEventListener("click", showSaveModal);
    }

    const confirmSaveButton = document.getElementById("confirmSave");
    if (confirmSaveButton) {
        confirmSaveButton.addEventListener("click", confirmSave);
    }

    const cancelSaveButton = document.getElementById("cancelSave");
    if (cancelSaveButton) {
        cancelSaveButton.addEventListener("click", cancelSave);
    }

    const editButton = document.getElementById("edit-button");
    if (editButton) {
        editButton.addEventListener("click", handleEdit);
    }
</script>
