---
import Layout from "../../layouts/Layout.astro";
import PocketBase from "pocketbase";
import { ui } from "../../i18n/ui.js";

const locale = (Astro.locals.lang as "en" | "fr") ?? "fr";

const { id } = Astro.params;
const pb = new PocketBase("http://127.0.0.1:8090/");

let record = null;
let error = null;

try {
    record = await pb.collection("SVG").getOne(id);
} catch (err) {
    error = ui[locale].svgDetail.notFound;
    console.error("Erreur lors de la récupération:", err);
}

let chatHistory = [];
if (record?.chat_history) {
    try {
        chatHistory = JSON.parse(record.chat_history);
    } catch (err) {
        console.error("Erreur parsing chat_history:", err);
    }
}
---

<Layout>
    <div class="relative min-h-screen bg-gradient-to-br from-purple-200 to-gray-100">
        <div class="p-8 pb-32">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-purple-800">
                        {ui[locale].svgDetail.title}
                    </h1>
                    <a href="/galerie" class="btn btn-secondary">
                        {ui[locale].svgDetail.backToGallery}
                    </a>
                </div>

                {error ? (
                    <div class="text-center py-16">
                        <p class="text-xl text-red-600">{error}</p>
                        <a href="/galerie" class="btn btn-primary mt-4">
                            {ui[locale].svgDetail.backToGallery}
                        </a>
                    </div>
                ) : (
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <h2 class="text-xl font-semibold mb-4">
                                    {ui[locale].svgDetail.svgPreview}
                                </h2>
                                <div id="svg-preview" class="bg-gray-50 p-6 rounded-lg flex items-center justify-center min-h-80">
                                    <div set:html={record.code} />
                                </div>
                            </div>

                            <div class="space-y-6">
                                <div>
                                    <h2 class="text-xl font-semibold mb-2">
                                        {ui[locale].svgDetail.initialPrompt}
                                    </h2>
                                    <p class="bg-gray-50 p-4 rounded-lg text-gray-700">
                                        {record.prompt}
                                    </p>
                                </div>

                                <div>
                                    <h2 class="text-xl font-semibold mb-2">
                                        {ui[locale].svgDetail.information}
                                    </h2>
                                    <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                                        <p>
                                            <span class="font-medium">{ui[locale].svgDetail.id}</span> {record.id}
                                        </p>
                                        <p>
                                            <span class="font-medium">{ui[locale].svgDetail.createdOn}</span> 
                                            {new Date(record.created).toLocaleDateString(locale === 'fr' ? 'fr-FR' : 'en-US')} 
                                            {ui[locale].svgDetail.at} {new Date(record.created).toLocaleTimeString(locale === 'fr' ? 'fr-FR' : 'en-US')}
                                        </p>
                                        <p>
                                            <span class="font-medium">{ui[locale].svgDetail.modifiedOn}</span> 
                                            {new Date(record.updated).toLocaleDateString(locale === 'fr' ? 'fr-FR' : 'en-US')} 
                                            {ui[locale].svgDetail.at} {new Date(record.updated).toLocaleTimeString(locale === 'fr' ? 'fr-FR' : 'en-US')}
                                        </p>
                                    </div>
                                </div>

                                <div>
                                    <h2 class="text-xl font-semibold mb-2">
                                        {ui[locale].svgDetail.actions}
                                    </h2>
                                    <div class="flex gap-3">
                                        <button onclick="copyCode()" class="btn btn-primary">
                                            {ui[locale].svgDetail.copyCode}
                                        </button>
                                        <button onclick="downloadSvg()" class="btn btn-secondary">
                                            {ui[locale].svgDetail.downloadSvg}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8">
                            <h2 class="text-xl font-semibold mb-4">
                                {ui[locale].svgDetail.conversationHistory}
                            </h2>
                            <div id="chat-history" class="bg-gray-50 p-6 rounded-lg max-h-96 overflow-y-auto space-y-4">
                                {chatHistory.map((message, index) => (
                                    <div class={`p-3 rounded-lg ${message.role === "user" ? "bg-blue-100 ml-8" : "bg-green-100 mr-8"}`}>
                                        <p class="font-medium text-sm mb-1">
                                            {message.role === "user" ? ui[locale].svgDetail.user : ui[locale].svgDetail.assistant}
                                        </p>
                                        <div class="text-sm">
                                            {message.role === "user" ? (
                                                <p>{message.content}</p>
                                            ) : (
                                                <pre class="whitespace-pre-wrap font-mono text-xs">
                                                    {message.content}
                                                </pre>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div class="mt-8">
                            <h2 class="text-xl font-semibold mb-2">{ui[locale].svgDetail.svgCode}</h2>
                            <textarea
                                id="svgCode"
                                class="w-full h-32 p-4 bg-gray-50 rounded-lg font-mono text-sm resize-none"
                                readonly
                            >{record.code}</textarea>
                        </div>
                    </div>
                )}
            </div>
        </div>

        <form 
            id="input-prompt-form" 
            class="fixed bottom-0 left-0 right-0 w-full bg-base-300 border-t border-gray-300 shadow-lg z-50" 
            autocomplete="off"
        >
            <input type="hidden" name="history" value={JSON.stringify(chatHistory)} />
            <input type="hidden" name="id" value={record?.id} />
            <div class="max-w-4xl mx-auto p-4">
                <div class="flex items-center gap-2">
                    <input 
                        id="prompt-input" 
                        name="editPrompt" 
                        type="text" 
                        class="input input-bordered flex-grow bg-white" 
                        placeholder={ui[locale].svgDetail.editPlaceholder}
                    />
                    <button class="btn btn-primary" type="submit">
                        {ui[locale].svgDetail.modify}
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div id="toast" class="toast toast-end hidden">
        <div class="alert alert-success">
            <span>Message</span>
        </div>
    </div>
</Layout>

<script define:vars={{ locale, ui }}>
    //@ts-nocheck
    const form = document.getElementById('input-prompt-form');
    const svgPreview = document.getElementById('svg-preview');
    const chatHistory = document.getElementById('chat-history');

    async function generateSVG(messages) {
        const response = await fetch("/api/generateSVG", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages }),
        });
        const data = await response.json();
        return data.svg.content;
    }

    async function update(updatedData) {
        const response = await fetch("/api/updateSVG", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedData),
        });
        return response;
    }

    function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const alertDiv = toast.querySelector(".alert");
        alertDiv.className = `alert alert-${type}`;
        alertDiv.querySelector("span").textContent = message;
        toast.classList.remove("hidden");

        setTimeout(() => {
            toast.classList.add("hidden");
        }, 3000);
    }

    function copyCode() {
        const codeTextarea = document.getElementById("svgCode");
        navigator.clipboard.writeText(codeTextarea.value).then(() => {
            showToast(ui[locale].svgDetail.codeCopied);
        });
    }

    function downloadSvg() {
        const code = document.getElementById("svgCode").value;
        const blob = new Blob([code], { type: "image/svg+xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "generated-svg.svg";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast(ui[locale].svgDetail.svgDownloaded);
    }

    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        console.log(JSON.stringify(Object.fromEntries(formData)));

        let prompt = {
            role: 'user',
            content: formData.get('editPrompt')
        };

        if (!prompt.content?.trim()) {
            showToast(ui[locale].svgDetail.enterPrompt, "error");
            return;
        }

        let history = JSON.parse(formData.get('history')) || [];
        history.push(prompt);

        document.getElementById('prompt-input').value = '';

        const originalSvg = svgPreview.innerHTML;
        svgPreview.innerHTML += `<span class="loading loading-ring loading-xl"></span>`;
        
        chatHistory.innerHTML += `
            <div class="p-3 rounded-lg bg-blue-100 ml-8">
                <p class="font-medium text-sm mb-1">${ui[locale].svgDetail.user}</p>
                <div class="text-sm">
                    <p>${prompt.content}</p>
                </div>
            </div>
        `;

        try {
            let aiResponse = await generateSVG(history);
            history.push({ role: 'assistant', content: aiResponse });

            const svgMatch = aiResponse.match(/<svg[\s\S]*?<\/svg>/i);
            aiResponse = svgMatch ? svgMatch[0] : aiResponse;

            console.log("svgCode: ", aiResponse);
            
            svgPreview.innerHTML = aiResponse;

            chatHistory.innerHTML += `
                <div class="p-3 rounded-lg bg-green-100 mr-8">
                    <p class="font-medium text-sm mb-1">${ui[locale].svgDetail.assistant}</p>
                    <div class="text-sm">
                        <pre class="whitespace-pre-wrap font-mono text-xs">${aiResponse}</pre>
                    </div>
                </div>
            `;

            document.getElementById('svgCode').value = aiResponse;

            const response = await update({
                id: formData.get("id"),
                code: aiResponse,
                chat_history: JSON.stringify(history),
            });
            const data = await response.json();

            if (data.success) {
                showToast(ui[locale].svgDetail.svgUpdatedSuccess);
                form.querySelector('input[name="history"]').value = JSON.stringify(history);
            } else {
                showToast(ui[locale].svgDetail.svgUpdateFailed, "error");
            }

        } catch (error) {
            console.error("Erreur:", error);
            showToast(ui[locale].svgDetail.generationError, "error");
            svgPreview.innerHTML = originalSvg;
        }

        chatHistory.scrollTop = chatHistory.scrollHeight;
    });

    window.copyCode = copyCode;
    window.downloadSvg = downloadSvg;
</script>
